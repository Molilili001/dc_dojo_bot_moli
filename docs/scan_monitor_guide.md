# 📡 扫描监听提醒功能 使用指南

> 本功能允许服务器管理员和帖主设置自动消息检测规则，当用户发送匹配的消息时，Bot 会自动执行指定动作（如回复、添加反应、回顶等）。

---

## 📋 目录

1. [功能概述](#功能概述)
2. [快速开始](#快速开始)
3. [命令列表](#命令列表)
4. [管理员功能](#管理员功能)
5. [帖主功能](#帖主功能)
6. [规则配置详解](#规则配置详解)
7. [常见问题](#常见问题)

---

## 功能概述

### 这个功能能做什么？

- **自动回顶**：用户发送"回顶"时，Bot 自动回复首楼链接
- **自动回复**：检测特定关键词，自动发送预设回复
- **自动反应**：为匹配的消息添加表情反应
- **定时删除**：触发消息和回复可设置延迟自动删除

### 谁可以使用？

| 角色 | 权限 |
|------|------|
| Bot 开发者 | 全部权限 |
| 服务器管理员 | 配置全服规则、权限管理 |
| 有权限的身份组 | 配置全服规则（需管理员授权） |
| 帖主 | 配置自己帖子内的规则（需服务器允许） |

---

## 快速开始

### 1️⃣ 查看当前状态

在任意频道输入：
```
/扫描监听提醒 状态
```

这会显示：
- 功能是否开启
- 贴主是否可以配置
- 当前规则数量
- 规则预览

### 2️⃣ 使用默认回顶功能

Bot 会自动为每个服务器创建默认回顶规则。用户在帖子内发送：
- `/回顶`
- `／回顶`（全角斜杠）
- `回顶`

Bot 会回复首楼链接，5分钟后自动删除。

---

## 命令列表

| 命令 | 说明 | 谁能用 |
|------|------|--------|
| `/扫描监听提醒 状态` | 查看功能状态 | 所有人 |
| `/扫描监听提醒 配置` | 服务器配置面板 | 管理员 |
| `/扫描监听提醒 帖子配置` | 帖子配置面板 | 帖主/管理员 |

---

## 管理员功能

### 打开配置面板

```
/扫描监听提醒 配置
```

### 配置面板按钮说明

| 按钮 | 功能 |
|------|------|
| **开关全服功能** | 启用/禁用整个功能 |
| **开关贴主配置** | 是否允许帖主配置自己帖子的规则 |
| **初始化回顶规则** | 创建默认回顶规则（如果不存在） |
| **设置限流** | 配置用户/帖子级别的回复冷却时间 |
| **设置论坛频道** | 限制功能只在指定论坛频道生效 |
| **添加规则** | 创建新的全服规则 |
| **查看全部规则** | 查看并管理现有规则 |
| **权限管理** | 授权其他用户/身份组管理权限 |

### 添加全服规则

1. 点击 **添加规则** 按钮
2. 填写弹出的表单：

| 字段 | 说明 | 示例 |
|------|------|------|
| 触发词 | 多个用逗号分隔 | `你好, hello, 嗨` |
| 匹配模式 | 精确/前缀/包含/正则 | `精确` |
| 动作类型 | 回复/回顶/反应/回复并反应 | `回复` |
| 回复内容 | 纯文本或JSON格式embed | `欢迎来到本服务器！` |
| 删除延迟 | 秒数，0表示不删除 | `300` |

### 管理现有规则

1. 点击 **查看全部规则**
2. 从下拉菜单选择要操作的规则
3. 查看规则详情
4. 可以进行以下操作：
   - **切换启用状态** - 启用/禁用规则
   - **编辑规则** - 修改规则设置
   - **删除规则** - 永久删除

### 设置论坛频道限制

1. 点击 **设置论坛频道** 按钮
2. 输入论坛频道 ID（每行一个）
3. 留空表示所有论坛频道都可用

**如何获取频道 ID？**
1. 开启 Discord 开发者模式（用户设置 → 高级 → 开发者模式）
2. 右键点击论坛频道 → 复制频道 ID

### 权限管理

只有服务器管理员可以管理权限。

1. 点击 **权限管理**
2. 选择添加用户权限或身份组权限
3. 输入用户/身份组 ID

授权后，这些用户/身份组可以配置全服规则。

---

## 帖主功能

### 前提条件

- 你是帖子的创建者（帖主）
- 服务器管理员开启了"贴主配置"权限

### 打开帖子配置面板

在帖子内输入：
```
/扫描监听提醒 帖子配置
```

### 帖子配置面板按钮说明

| 按钮 | 功能 |
|------|------|
| **添加规则** | 为当前帖子添加规则 |
| **管理规则** | 查看并管理帖子规则 |
| **禁用所有规则** | 一键禁用帖子内所有规则 |

### 帖子规则 vs 全服规则

- **帖子规则优先**：如果帖子规则和全服规则都匹配，优先执行帖子规则
- **限制数量**：每个帖子最多 10 条规则
- **只在本帖生效**：帖子规则只影响当前帖子

---

## 规则配置详解

### 匹配模式

| 模式 | 中文 | 说明 | 示例 |
|------|------|------|------|
| `exact` | 精确 | 消息内容必须完全一致 | 触发词 `你好` 只匹配 `你好`，不匹配 `你好啊` |
| `prefix` | 前缀 | 消息以触发词开头 | 触发词 `!` 匹配 `!help`、`!ping` |
| `contains` | 包含 | 消息包含触发词 | 触发词 `hello` 匹配 `say hello world` |
| `regex` | 正则 | 正则表达式匹配 | 触发词 `\d{4}` 匹配任意4位数字 |

### 动作类型

| 动作 | 中文 | 说明 |
|------|------|------|
| `reply` | 回复 | 发送自定义回复消息 |
| `go_to_top` | 回顶 | 回复首楼链接（帖子专用） |
| `react` | 反应 | 为触发消息添加表情 |
| `reply_and_react` | 回复并反应 | 同时回复和添加表情 |

### 限流设置

限流可以防止规则被频繁触发。

| 类型 | 说明 |
|------|------|
| 用户限流 | 同一用户触发同一规则的间隔 |
| 帖子限流 | 同一帖子内触发同一规则的间隔 |

- 设为 `0` 表示不限流
- 规则级限流优先于全服默认限流

### 模板变量

在回复内容中可以使用以下变量：

| 变量 | 替换为 |
|------|--------|
| `{user}` | 触发者的 @提及 |
| `{user_name}` | 触发者的显示名称 |
| `{channel}` | 当前频道的 #提及 |
| `{channel_name}` | 当前频道名称 |
| `{guild_name}` | 服务器名称 |

**示例**：
```
你好 {user}！欢迎来到 {guild_name}！
```

### Embed 格式回复

除了普通文本，回复内容还支持 JSON 格式的 Embed，可以发送更美观的嵌入消息。

**使用方法**：在回复内容中输入以 `{` 开头的 JSON 格式文本。

**JSON 格式示例**：

```json
{
  "title": "欢迎来到服务器",
  "description": "你好 {user}！\n感谢加入我们。",
  "color": 65280,
  "fields": [
    {"name": "规则", "value": "请遵守服务器规则", "inline": true},
    {"name": "帮助", "value": "有问题请 @管理员", "inline": true}
  ],
  "footer": {"text": "来自 {guild_name}"}
}
```

**Embed 字段说明**：

| 字段 | 说明 | 示例 |
|------|------|------|
| `title` | 标题 | `"欢迎"` |
| `description` | 描述内容 | `"你好！"` |
| `color` | 颜色（十进制数值） | `65280`（绿色）、`16711680`（红色） |
| `fields` | 字段数组 | 见上方示例 |
| `footer` | 页脚 | `{"text": "页脚文字"}` |
| `thumbnail` | 缩略图 | `{"url": "图片链接"}` |
| `image` | 大图 | `{"url": "图片链接"}` |

**颜色代码参考**：
- 🟢 绿色：`65280`
- 🔵 蓝色：`255`
- 🔴 红色：`16711680`
- 🟡 黄色：`16776960`
- 🟣 紫色：`10181046`

**注意事项**：
- JSON 格式必须正确，否则会作为普通文本发送
- Embed 中的文本字段同样支持模板变量（如 `{user}`）
- 可以在 [Discord Embed 生成器](https://discohook.org/) 预览效果

---

## 常见问题

### Q: 为什么规则没有触发？

检查以下几点：
1. 功能是否开启（`/扫描监听提醒 状态`）
2. 规则是否启用（查看规则详情）
3. 是否在限流冷却期内
4. 论坛频道是否在允许列表中
5. 匹配模式是否正确

### Q: 帖主无法配置规则？

可能原因：
1. 服务器禁用了"贴主配置"权限
2. 不是帖子的创建者
3. 不在帖子内执行命令

### Q: 如何完全关闭功能？

管理员执行 `/扫描监听提醒 配置` → 点击 **开关全服功能** 关闭。

### Q: 正则表达式报错？

确保正则表达式语法正确。可以在 https://regex101.com 测试。

常见错误：
- 未转义特殊字符（如 `.`、`?`、`*`）
- 括号不匹配

### Q: 回顶功能不工作？

确保：
1. 在帖子内使用（不是普通频道）
2. 帖子有历史消息（可以获取首楼）
3. 回顶规则已启用

---

## 技术支持

如有问题，请联系服务器管理员或 Bot 开发者。