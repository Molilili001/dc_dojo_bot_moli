# Discord 道馆挑战机器人

这是一个功能强大、高度可定制的 Discord 机器人，旨在通过“道馆挑战”的形式，帮助服务器成员学习特定知识、熟悉社区规则或进行技能考核。机器人内置了完善的进度跟踪、失败惩罚、自动身份组奖励和精细化的权限管理机制。

## ✨ 核心功能

### 👤 对于普通用户

*   **交互式挑战**: 用户通过点击按钮与机器人交互，选择并开始道馆挑战。
*   **多样化题型**: 支持**选择题**、**判断题**（按钮作答）和**填空题**（弹窗作答），满足不同考核需求。
*   **随机题库模式**: 可选地从一个大的题库中随机抽取指定数量的题目进行考核，让每次挑战都充满新意。
*   **学习教程**: 每个道馆都包含详细的图文教程，方便用户在挑战前学习。
*   **进度可视化**: 在选择列表上，用户可以清晰地看到每个道馆的“已通关”或“未通关”状态。
*   **失败冷却机制**: 多次挑战失败会触发1至12小时不等的冷却时间，防止恶意尝试。
*   **智能错题回顾**:
    *   挑战**成功**后，回顾中会同时展示用户的错误答案和**正确答案**。
    *   挑战**失败**后，回顾中只展示用户的错误答案，以鼓励再次尝试。
*   **交互式徽章墙**:
    *   用户可通过 `/我的徽章墙` 指令或服务器内的“徽章墙面板”，以交互式卡片的形式，浏览所有已获得的、由管理员自定义的图片徽章和介绍。
*   **毕业系统**:
    *   当用户完成服务器内**所有**道馆的挑战后，可以通过“毕业面板”领取最终的毕业身份组奖励。
*   **前置道馆**: 管理员可以设置挑战面板的前置条件，用户必须先完成指定的道馆，才能挑战该面板中的道馆。

### 🛠️ 对于管理员/馆主

机器人提供了一套完整的 `/道馆` 和其他管理指令，用于管理整个系统：

*   **内容管理**:
    *   `/道馆 建造`: 通过上传 `.json` 文件创建一个新道馆。
    *   `/道馆 更新`: 使用新的 `.json` 文件覆盖和更新现有道馆。
    *   `/道馆 删除`: 永久删除一个道馆及其所有用户进度。
    *   `/道馆 列表`: 查看服务器上所有道馆的名称、ID、营业状态以及**徽章配置状态**。
    *   `/道馆 后门`: 以 JSON 格式导出任意道馆的完整数据，方便备份和修改。
    *   `/道馆 停业`: 设置一个道馆的营业状态。选择“停业”将使其暂时无法被挑战。
*   **面板管理**:
    *   `/道馆 召唤`: 在指定频道创建永久的**道馆挑战面板**。此命令极为灵活，支持：
        *   **启用/禁用黑名单**: 控制通过此面板完成挑战的用户是否需要经过黑名单检查。
        *   **自定义介绍**: 为每个挑战面板设置独特的欢迎语。
        *   **特定道馆列表**: 创建一个只包含指定道馆的挑战面板。
        *   **独立奖励**: 为不同道馆组合配置独立的通关奖励（添加/移除身份组）。
        *   **按数量奖励**: 设置“完成X个道馆后即发放奖励”，而无需用户完成面板上的所有道馆。
        *   **设置前置道馆**: 要求用户必须先完成某些道馆才能挑战此面板。
    *   `/道馆 徽章墙面板`: 在指定频道创建一个永久的**徽章墙展示面板**。
    *   `/道馆 毕业面板`: 在指定频道创建一个永久的**毕业面板**，用于发放“全部通关”奖励。
*   **用户管理**:
    *   `/道馆 重置进度`: **[新]** 完全清空指定用户的所有挑战记录、失败记录和**已领取的身份组奖励记录**。
    *   `/道馆 解除处罚`: 立即移除用户的挑战冷却时间。
*   **双层处罚系统**:
    *   **黑名单 (Blacklist)**:
        *   **作用**: 阻止用户**获取奖励**。被黑名单的用户仍可挑战道馆，但无法获得任何身份组奖励。
        *   **管理**: 使用 `/道馆黑名单` 指令进行管理（添加、移除、查看、批量记录、清空）。
    *   **封禁名单 (Ban List)**:
        *   **作用**: **绝对禁止**用户**开始任何挑战**。这是最高级别的处罚。
        *   **管理**: 使用 `/道馆封禁` 指令进行管理（添加、移除、查看）。
*   **精细化权限系统**:
    *   `/道馆 设置馆主`: **[功能已扩展]** 无需给予服务器管理员，即可将**所有**道馆管理指令（包括 `/道馆` 分组下的所有指令、`/道馆黑名单` 和 `/道馆封禁`）的权限，单独或全部授予给**指定用户**或**指定身份组**。
*   **自动化联动**:
    *   **私信指令 (DM Command)**: 可配置监听一个受信任的机器人伙伴发送的私信。
        *   `{"punish": "用户ID"}`: 收到此格式的私信后，会自动将该用户加入**黑名单**，并**完全重置其所有进度**。
        *   `{"pass": "用户ID"}`: 收到此格式的私信后，会自动为该用户授予一个预设的身份组。
*   **数据安全 (混合备份系统)**:
    *   **即时触发备份**: 在使用 `/道馆 更新` 或 `/道馆 删除` 时，会立即对被操作的道馆进行备份。
    *   **每日例行备份**: 每日自动备份所有道馆数据。
    *   **增量逻辑**: 只有当道馆数据发生实际变更时才会创建新备份文件。
    *   **结构化存储**: 备份文件存储在 `gym_backups/服务器ID/道馆ID/` 目录下。
*   **开发者工具**:
    *   `/状态`: [仅限开发者] 查看VPS的实时CPU、内存、磁盘占用率以及机器人的运行时间和内存消耗。
*   **大型服务器优化**: 默认配置禁用了成员缓存，使得机器人在大型服务器中也能以极低的内存占用稳定运行。

## 🚀 快速开始

### 1. 环境准备

*   Python 3.8 或更高版本
*   克隆或下载本仓库代码

### 2. 安装依赖

在您的终端中运行以下命令来安装核心依赖：

```bash
pip install -r requirements.txt
```

或者，手动安装所有必需的库：

```bash
pip install discord.py aiosqlite aiohttp pytz psutil aiofiles
```

### 3. 配置机器人

1.  在项目根目录 (`F:\dcbot`) 下，创建一个名为 `config.json` 的文件。
2.  将您的机器人令牌（Token）和可选的联动功能配置填入该文件中。

    **基础配置:**
    ```json
    {
      "BOT_TOKEN": "在这里粘贴你的机器人令牌"
    }
    ```

    **包含自动化联动功能的完整配置示例:**
    ```json
    {
      "BOT_TOKEN": "在这里粘贴你的机器人令牌",
      "AUTO_BLACKLIST_MONITOR": {
        "enabled": true,
        "target_bot_id": "1374372307916554351",
        "pass_role_id": "1234567890123456789"
      }
    }
    ```
    *关于自动化联动的详细说明，请参考本文档的 `🔗 自动化联动` 章节。*

### 4. 启动机器人

完成以上步骤后，在终端中运行以下命令即可启动机器人：

```bash
python bot.py
```

## 🔗 自动化联动

这是一个高级功能，允许本机器人监听另一个受信任的机器人伙伴发出的消息，并自动执行相应操作。

### 工作模式: 私聊 JSON (DM)

*   **工作原理**: 机器人会监听来自 `config.json` 中指定的 `target_bot_id` 的**私聊消息 (DM)**。当收到一条内容为特定JSON格式的消息时，它会立即触发相应操作。
*   **全局同步**: 所有通过此模式触发的操作都是**全局的**，即会在机器人所在的所有服务器上执行。

### 支持的JSON指令

*   **处罚用户 (加入黑名单并重置进度)**
    *   **格式**: `{ "punish": "被处罚用户的ID" }`
    *   **效果**:
        1.  将指定用户加入所有服务器的**黑名单** (`cheating_blacklist`)。
        2.  **完全重置**该用户在所有服务器的道馆进度、失败记录和奖励记录。

*   **授予身份组**
    *   **格式**: `{ "pass": "目标用户的ID" }`
    *   **效果**: 在所有服务器中，为指定用户授予在 `config.json` 中由 `pass_role_id` 定义的身份组。

### 配置方法

要启用此功能，请在 `config.json` 文件中添加 `AUTO_BLACKLIST_MONITOR` 部分：

*   `enabled`: `true` 或 `false`。设为 `true` 以启用此功能。
*   `target_bot_id`: (字符串) 你要监听的目标机器人的用户ID。
*   `pass_role_id`: (字符串, 可选) 当收到 `pass` 指令时，要授予的身份组ID。

## 📁 项目结构

*   `config.json`: 存放您的机器人令牌和联动功能配置。
*   `progress.db`: SQLite 数据库文件，存储所有用户进度和服务器设置。
*   `botlog/`: 存放机器人运行日志 (`bot.log`) 的文件夹。
*   `gym_backups/`: 存放所有道馆数据备份的文件夹。
*   `requirements.txt`: 项目的 Python 依赖库列表。

## 🔑 所需权限

### 1. Discord 开发者后台设置

在您的机器人应用页面 (Developer Portal) -> Bot 标签页下，请开启以下 **特权网关意图 (Privileged Gateway Intents)**：

*   [x] **SERVER MEMBERS INTENT**
*   [x] **MESSAGE CONTENT INTENT**

### 2. 机器人邀请权限

生成机器人邀请链接时，请确保勾选以下 **Bot Permissions**：

*   `Manage Roles` (管理身份组) - **必需**
*   `Send Messages` (发送消息)
*   `Embed Links` (嵌入链接) - **必需**
*   `Attach Files` (附加文件) - **必需**
*   `Read Message History` (读取消息历史) - **必需**
*   `Use Slash Commands` (使用应用命令) - **必需**
*   `View Channels` (查看频道) - **必需**

## 🔧 如何使用

1.  **启动并邀请机器人** 到您的服务器。
2.  在一个您希望设置为挑战中心的频道，使用 `/道馆 召唤` 命令。
3.  使用 `/道馆 建造` 命令来创建您的第一个道馆。您可以参考项目中的 `道馆示例.json` 文件来编写您的道馆数据。
4.  使用 `/道馆 设置馆主` 来为您的管理员或特定角色分配管理权限。
5.  根据需要，使用 `/道馆黑名单` 或 `/道馆封禁` 来管理问题用户。

## 📝 道馆JSON格式说明

道馆的所有内容都通过一个JSON文件进行定义。以下是一些关键的格式说明：

### 基础结构
```json
{
  "id": "unique_gym_id",
  "name": "道馆名称",
  "description": "道馆的简短描述",
  "tutorial": [
    "这是教程的第一段。",
    "这是教程的第二段。"
  ],
  "questions": [
    {
      "id": "q1",
      "type": "multiple_choice",
      "text": "问题文本",
      "options": ["选项A", "选项B", "选项C"],
      "correct_answer": "选项B"
    }
  ]
}
```

### 可选字段

*   `questions_to_ask`: (整数) 从 `questions` 列表中随机抽取多少道题进行考核。
*   `allowed_mistakes`: (整数) 允许答错多少题后依然算作通关（默认为0）。
*   `badge_image_url`: (字符串) 通关后在徽章墙显示的图片URL。
*   `badge_description`: (字符串) 在徽章墙显示的徽章描述。

### 题型详解

*   **选择题 (`multiple_choice`)**: `correct_answer` 必须是 `options` 列表中的一个完整字符串。
*   **填空题 (`fill_in_blank`)**: `correct_answer` 可以是一个字符串，也可以是一个包含多个可接受答案的字符串列表。
*   **判断题 (`true_false`)**: `correct_answer` 必须是 `"正确"` 或 `"错误"`。

## 📄 许可证

本项目采用 [MIT License](LICENSE) 开源许可证。

## ✍️ 作者

*   **Molilili001**

## ⚠️ 大型服务器开发者注意事项

为了能在大型服务器（超过1000名成员）上高效、低耗地运行，本机器人采用了一系列关键的优化策略：

### 1. 禁用的成员缓存 (Member Cache)

*   **策略**: 机器人默认**禁用了成员缓存**。
*   **优势**: 极大地降低了内存占用。
*   **编码要求**: 当需要获取一个**未在交互中提供**的成员对象时，**必须**使用异步方法 `await guild.fetch_member(member_id)`。

### 2. 异步文件操作 (Asynchronous I/O)

*   **策略**: 所有文件读写操作都使用 `aiofiles` 库进行异步处理。
*   **优势**: 文件I/O不会阻塞主事件循环，确保机器人响应流畅。

### 3. 后台处理长耗时任务 (Background Tasks)

*   **策略**: 对于可能耗时极长的操作（如批量记录黑名单），机器人会将其转为后台任务。
*   **优势**: 避免交互超时，并能可靠地通过 `interaction.followup.send()` 发送完成通知。