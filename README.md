# Discord 道馆挑战机器人

这是一个功能强大、高度可定制的 Discord 机器人，旨在通过“道馆挑战”的形式，帮助服务器成员学习特定知识、熟悉社区规则或进行技能考核。机器人内置了完善的进度跟踪、失败惩罚和自动身份组奖励机制。

## ✨ 核心功能

### 👤 对于普通用户

*   **交互式挑战**: 用户通过点击按钮与机器人交互，选择并开始道馆挑战。
*   **多样化题型**: 支持**选择题**、**判断题**（按钮作答）和**填空题**（弹窗作答），满足不同考核需求。
*   **随机题库模式**: 可选地从一个大的题库中随机抽取指定数量的题目进行考核，让每次挑战都充满新意。
*   **学习教程**: 每个道馆都包含详细的图文教程，方便用户在挑战前学习。
*   **进度可视化**: 在选择列表上，用户可以清晰地看到每个道馆的“已通关”或“未通关”状态。
*   **失败冷却机制**: 多次挑战失败会触发1至12小时不等的冷却时间，防止恶意尝试。
*   **全局身份组管理**: 成功完成服务器内所有道馆挑战后，机器人会根据管理员的设置，自动**授予**和/或**移除**指定身份组。
*   **错题回顾**: 挑战失败后，机器人会以列表形式展示用户答错的所有题目和他们给出的错误答案，帮助用户复盘和学习。

### 🛠️ 对于管理员/馆主

机器人提供了一套完整的 `/道馆` 斜杠命令，用于管理整个系统：

*   **内容管理**:
    *   `/道馆 建造`: 通过上传 `.json` 文件创建一个新道馆。
    *   `/道馆 更新`: 使用新的 `.json` 文件覆盖和更新现有道馆。
    *   `/道馆 删除`: 永久删除一个道馆及其所有用户进度。
    *   `/道馆 列表`: 查看服务器上所有道馆的名称和ID。
    *   `/道馆 后门`: 以 JSON 格式导出任意道馆的完整数据，方便备份和修改。
*   **营业状态管理**:
    *   `/道馆 停业 <道馆ID> status:[开启/停业]`: 设置一个道馆的营业状态。选择“停业”将使其暂时无法被挑战。
*   **系统与用户管理**:
    *   `/道馆 召唤`: 在指定频道创建永久的挑战面板。此命令极为灵活，支持：
        *   **启用/禁用黑名单**: 通过 `启用黑名单` 必选参数，可以控制通过此面板完成挑战的用户是否需要经过黑名单检查。
        *   **自定义介绍**: 通过 `introduction` 参数，可以为每个挑战面板设置独特的欢迎语。
        *   **特定道馆列表**: 通过 `gym_ids` 参数，可以创建一个只包含指定道馆的挑战面板。
        *   **独立奖励**: 面板的通关奖励（添加/移除身份组）会与指定的道馆列表挂钩，实现对不同道馆组合的独立奖励配置。
        *   **按数量奖励**: 通过 `通关数量` 参数，可以设置“完成X个道馆后即发放奖励”，而无需用户完成面板上的所有道馆。
    *   `/道馆 重置进度`: 清空指定用户的所有挑战记录和失败记录。
    *   `/道馆 解除处罚`: 立即移除用户的挑战冷却时间。
*   **黑名单管理**:
    *   `/道馆黑名单`: 一个统一的指令，通过 `action` 选项管理黑名单。
        *   `添加`: 将一个用户或身份组直接加入黑名单。
        *   `移除`: 将一个用户或身份组从黑名单中移除。
        *   `记录`: **[已为大型服务器深度优化]** 可靠地将一个身份组的所有成员（即使数万甚至数十万）在后台添加到黑名单。任务会立即开始并在完成后发送通知，规避了交互超时风险。
        *   `清空`: 一键清空服务器的所有黑名单记录，并有安全确认提示。
*   **开发者工具**:
    *   `/状态`: [仅限开发者] 查看VPS的实时CPU、内存、磁盘占用率以及机器人的运行时间和内存消耗。
*   **精细化权限**:
    *   `/道馆 设置馆主`: 无需给予服务器管理员，即可将包括**建造、更新、删除、停业**在内的所有管理权限，单独或全部授予给**指定用户**或**指定身份组**。
*   **数据安全 (混合备份系统)**:
    *   **即时触发备份**: 在使用 `/道馆 更新` 或 `/道馆 删除` 指令时，机器人会**立即**对被操作的**特定道馆**进行一次备份，确保在修改前总有最新的版本。
    *   **每日例行备份**: 每日的自动任务依然会运行，作为一道额外的保险，检查并备份所有道馆的数据。
    *   **增量逻辑**: 无论是即时备份还是每日备份，只有当道馆数据发生实际变更时，才会创建新的备份文件，避免冗余。
    *   **结构化存储**: 备份文件存储在 `gym_backups/服务器ID/道馆ID/` 目录下，并以精确到秒的时间戳 (`年-月-日_时-分-秒.json`) 命名，让您可以轻松找到任何道馆的任何一次历史版本。
    *   **本地化时间**: 所有的备份和日志时间戳均以**北京时间 (UTC+8)** 记录，方便您进行查阅。
    *   **大型服务器优化**: 默认配置禁用了成员缓存 (`member_cache`)，使得机器人在拥有数万甚至数十万成员的服务器中也能以极低的内存占用（通常低于100MB）稳定运行。
    
    ## 🚀 快速开始
    
### 1. 环境准备

*   Python 3.8 或更高版本
*   克隆或下载本仓库代码

### 2. 安装依赖

在您的终端中运行以下命令来安装核心依赖：

```bash
pip install -r requirements.txt
```

或者，手动安装所有必需的库：

```bash
pip install discord.py aiosqlite aiohttp pytz psutil aiofiles
```

### 3. 配置机器人

1.  在项目根目录 (`F:\dcbot`) 下，创建一个名为 `config.json` 的文件。
2.  将您的机器人令牌（Token）填入该文件中，格式如下：

    ```json
    {
      "BOT_TOKEN": "在这里粘贴你的机器人令牌"
    }
    ```

### 4. 启动机器人

完成以上步骤后，在终端中运行以下命令即可启动机器人：

```bash
python bot.py
```

## 📁 项目结构

机器人在运行时会自动生成和使用以下文件和文件夹：

*   `config.json`: 存放您的机器人令牌。
*   `progress.db`: SQLite 数据库文件，存储所有用户进度和服务器设置。
*   `botlog/`: 存放机器人运行日志 (`bot.log`) 的文件夹。
*   `gym_backups/`: 存放所有道馆数据备份的文件夹。
*   `requirements.txt`: 项目的 Python 依赖库列表。

## 🔑 所需权限

要让机器人正常工作，请确保完成以下两部分配置：

### 1. Discord 开发者后台设置

在您的机器人应用页面 (Developer Portal) -> Bot 标签页下，请开启以下 **特权网关意图 (Privileged Gateway Intents)**：

*   [x] **SERVER MEMBERS INTENT**
*   [x] **MESSAGE CONTENT INTENT**

### 2. 机器人邀请权限

生成机器人邀请链接时，请确保勾选以下 **Bot Permissions**：

*   `Manage Roles` (管理身份组) - **必需**，用于自动授予奖励。
*   `Send Messages` (发送消息)
*   `Embed Links` (嵌入链接) - **必需**，所有界面都基于此。
*   `Attach Files` (附加文件) - **必需**，用于上传和下载道馆的JSON数据。
*   `Read Message History` (读取消息历史) - **必需**，用于响应挑战面板的交互。
*   `Use Slash Commands` (使用应用命令) - **必需**，机器人所有功能都基于此。
*   `View Channels` (查看频道) - **必需**，允许机器人在特定频道工作。

## 🔧 如何使用

1.  **启动并邀请机器人** 到您的服务器。
2.  在一个您希望设置为挑战中心的频道，使用 `/道馆 召唤` 命令。此命令现在支持多个强大的可选参数，可以组合使用：
    *   **基础用法 (全局)**: `/道馆 召唤 启用黑名单:是 role_to_add:@大师徽章`
        *   这将创建一个包含服务器**所有**道馆的面板。用户需要完成所有道馆才能获得“大师徽章”身份组。
    *   **自定义介绍**: `/道馆 召唤 启用黑名单:是 introduction:欢迎来到新手村！请完成以下挑战。`
        *   这会用您提供的文字替换默认的欢迎语。
    *   **特定道馆列表**: `/道馆 召唤 启用黑名单:是 gym_ids:gym_rule,gym_guide role_to_add:@入门徽章`
        *   这将创建一个**只包含** `gym_rule` 和 `gym_guide` 这两个道馆的面板。
        *   用户只需完成这两个道馆，即可获得“入门徽章”身份组，而无需挑战服务器上的其他道馆。
    *   **组合使用**: `/道馆 召唤 启用黑名单:否 gym_ids:gym_a,gym_b introduction:高级挑战区 role_to_add:@高手 role_to_remove:@新手`
        *   创建一个只包含 `gym_a` 和 `gym_b` 的面板，拥有自定义介绍，**不进行黑名单检查**，并在通关后授予“高手”身份组，同时移除“新手”身份组。
    *   **按数量奖励**: `/道馆 召唤 启用黑名单:是 gym_ids:gym_a,gym_b,gym_c,gym_d 通关数量:2 role_to_add:@积极分子`
        *   创建一个包含四个指定道馆的面板。用户只需完成这四个道馆中的**任意两个**，即可获得“积极分子”身份组。
3.  使用 `/道馆 建造` 命令来创建您的第一个道馆。您可以参考项目中的 `道馆示例.json` 文件来编写您的道馆数据，然后将该文件通过指令的 `json_file` 参数上传。
4.  创建成功后，用户就可以通过挑战面板开始挑战了！

## 📝 道馆JSON格式说明

道馆的所有内容都通过一个JSON文件进行定义。以下是一些关键的格式说明：

### 选择题UI优化
为了解决选项文字过长在手机上显示不全的问题，机器人的选择题界面进行了优化。现在，选项的完整文字会显示在问题描述中，而按钮上只显示对应的字母（A, B, C...）。

因此，在创建选择题时，`correct_answer` 字段的值**必须是 `options` 列表中的完整字符串**，而不是字母。

**示例:**
```json
{
  "id": "q1_long_option",
  "type": "multiple_choice",
  "text": "关于机器人的某个非常复杂的功能，以下描述哪项是正确的？",
  "options": [
    "这是一个非常非常长的选项，详细描述了功能A的各种细节和特定情况。",
    "这是另一个同样很长的选项，它解释了功能B的工作原理和限制条件。",
    "功能C的简短描述。"
  ],
  "correct_answer": "这是另一个同样很长的选项，它解释了功能B的工作原理和限制条件。"
}
```
在这个例子中，尽管用户在Discord上点击的是标为“B”的按钮，但在JSON中，`correct_answer` 必须填写选项B的完整文本。

### 填空题多答案支持

为了提高灵活性，`fill_in_blank` 类型的题目现在支持多个正确答案。只需将 `correct_answer` 字段的值设置为一个字符串数组即可。

**示例:**
```json
{
  "id": "q3_channel_knowledge",
  "type": "fill_in_blank",
  "text": "官方的重要通知会在哪个频道发布？",
  "correct_answer": [
    "#📢｜公告发布",
    "公告发布"
  ]
}
```
在上述例子中，用户回答 `#📢｜公告发布` 或 `公告发布` 都会被判为正确。机器人会自动忽略答案的大小写和首尾空格。

### 随机题库设置

您可以选择让道馆从题库中随机抽取一部分题目进行考核。只需在JSON的顶层添加一个可选的 `questions_to_ask` 字段即可。

**示例:**
```json
{
  "id": "community_navigation",
  "name": "🧭 社区导航道馆",
  "description": "...",
  "tutorial": [...],
  "questions_to_ask": 2,
  "questions": [
    { "id": "q1", ... },
    { "id": "q2", ... },
    { "id": "q3", ... }
  ]
}
```
在这个例子中，尽管题库中有3道题，但每次用户挑战时，机器人只会随机抽取其中的2道题进行考核。如果省略 `questions_to_ask` 字段，机器人则会按顺序提问所有题目。

### 判断题支持

除了选择题和填空题，机器人现在原生支持判断题。

**示例:**
```json
{
 "id": "q4_true_false",
 "type": "true_false",
 "text": "判断题：在提问时，为了尽快得到答案，可以直接私信管理员或热心成员。",
 "correct_answer": "错误"
}
```
当 `type` 设置为 `true_false` 时，机器人会自动生成“正确”和“错误”两个按钮供用户选择。您只需在 `correct_answer` 中指定正确答案即可。

### 容错机制设置

您可以为每个道馆设置一定的容错空间，允许用户在答错指定数量的题目后依然能够通关。只需在JSON的顶层添加一个可选的 `allowed_mistakes` 字段。

**示例:**
```json
{
 "id": "advanced_knowledge",
 "name": "⚙️ 进阶知识道馆",
 "description": "...",
 "tutorial": [...],
 "questions_to_ask": 5,
 "allowed_mistakes": 1,
 "questions": [
   { "id": "q1", ... },
   { "id": "q2", ... },
   { "id": "q3", ... },
   { "id": "q4", ... },
   { "id": "q5", ... }
 ]
}
```
在这个例子中，用户需要回答5道题，但只要答错的题目数量不超过1题（即最多错1题），挑战就会被判为成功。如果省略 `allowed_mistakes` 字段，则默认值为0，用户必须全部答对才能通关。

## 📄 许可证

本项目采用 [MIT License](LICENSE) 开源许可证。

## ✍️ 作者

*   **Molilili001**

## ⚠️ 大型服务器开发者注意事项

为了能在大型服务器（超过1000名成员）上高效、低耗地运行，本机器人采用了一系列关键的优化策略：

### 1. 禁用的成员缓存 (Member Cache)

*   **策略**: 机器人默认**禁用了成员缓存**。
*   **优势**: 不会在启动时加载所有服务器成员列表，使得机器人在拥有数万甚至数十万成员的服务器中也能以极低的内存占用（通常低于100MB）稳定运行。
*   **编码要求**:
    *   直接使用 `guild.get_member(member_id)` 将几乎总是返回 `None`。
    *   当需要获取一个**未在交互中提供**的成员对象时，**必须**使用异步方法 `await guild.fetch_member(member_id)` 来通过API向Discord请求该成员的数据。

### 2. 异步文件操作 (Asynchronous I/O)

*   **策略**: 所有文件读写操作（如备份、导出JSON）都使用 `aiofiles` 库进行异步处理。
*   **优势**: 文件I/O不会阻塞主事件循环。这在高并发环境下至关重要，可以防止机器人在保存或读取文件时出现“卡顿”或响应延迟，确保流畅的用户体验。

### 3. 后台处理长耗时任务 (Background Tasks)

*   **策略**: 对于可能耗时极长的操作（如将数万名成员记录到黑名单），机器人会将其转为后台任务。
*   **优势**:
    *   **避免交互超时**: 指令会立即响应用户“任务已开始”，而不是等待任务完成，从而完美规避了Discord 15分钟的交互超时限制。
    *   **可靠的结果通知**: 任务在后台完成后，会通过 `interaction.followup.send()` 发送一条全新的消息来通知操作者结果，确保了即使任务耗时很长，结果也能成功送达。

这是一个用“更健壮的编码模式”换取“极致性能和稳定性”的必要权衡。对于所有依赖 `interaction` 或 `message` 上下文获取用户的操作，现有功能不受影响。