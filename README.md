# Discord 道馆挑战机器人

这是一个功能强大、高度可定制的 Discord 机器人，旨在通过“道馆挑战”的形式，帮助服务器成员学习特定知识、熟悉社区规则或进行技能考核。机器人内置了完善的进度跟踪、失败惩罚和自动身份组奖励机制。

## ✨ 核心功能

### 👤 对于普通用户

*   **交互式挑战**: 用户通过点击按钮与机器人交互，选择并开始道馆挑战。
*   **多样化题型**: 支持**选择题**、**判断题**（按钮作答）和**填空题**（弹窗作答），满足不同考核需求。
*   **随机题库模式**: 可选地从一个大的题库中随机抽取指定数量的题目进行考核，让每次挑战都充满新意。
*   **学习教程**: 每个道馆都包含详细的图文教程，方便用户在挑战前学习。
*   **进度可视化**: 在选择列表上，用户可以清晰地看到每个道馆的“已通关”或“未通关”状态。
*   **失败冷却机制**: 多次挑战失败会触发1至12小时不等的冷却时间，防止恶意尝试。
*   **全局身份组管理**: 成功完成服务器内所有道馆挑战后，机器人会根据管理员的设置，自动**授予**和/或**移除**指定身份组。

### 🛠️ 对于管理员/馆主

机器人提供了一套完整的 `/道馆` 斜杠命令，用于管理整个系统：

*   **内容管理**:
    *   `/道馆 建造`: 通过 JSON 数据创建全新的道馆。
    *   `/道馆 更新`: 使用新的 JSON 数据覆盖和更新现有道馆。
    *   `/道馆 删除`: 永久删除一个道馆及其所有用户进度。
    *   `/道馆 列表`: 查看服务器上所有道馆的名称和ID。
    *   `/道馆 后门`: 以 JSON 格式导出任意道馆的完整数据，方便备份和修改。
*   **系统与用户管理**:
    *   `/道馆 召唤`: 在指定频道创建永久的挑战面板，并可以灵活配置全局通关奖励（添加身份组、移除身份组、或两者兼有）。
    *   `/道馆 重置进度`: 清空指定用户的所有挑战记录和失败记录。
    *   `/道馆 解除处罚`: 立即移除用户的挑战冷却时间。
*   **精细化权限**:
    *   `/道馆 设置馆主`: 无需给予服务器管理员，即可将上述管理权限单独或全部授予给**指定用户**或**指定身份组**。

## 🚀 快速开始

### 1. 环境准备

*   Python 3.8 或更高版本
*   克隆或下载本仓库代码

### 2. 安装依赖

在您的终端中运行以下命令来安装核心依赖：

```bash
pip install discord.py
```

### 3. 配置机器人

1.  在项目根目录 (`F:\dcbot`) 下，创建一个名为 `config.json` 的文件。
2.  将您的机器人令牌（Token）填入该文件中，格式如下：

    ```json
    {
      "BOT_TOKEN": "在这里粘贴你的机器人令牌"
    }
    ```

### 4. 启动机器人

完成以上步骤后，在终端中运行以下命令即可启动机器人：

```bash
python bot.py
```

## 🔑 所需权限

要让机器人正常工作，请确保完成以下两部分配置：

### 1. Discord 开发者后台设置

在您的机器人应用页面 (Developer Portal) -> Bot 标签页下，请开启以下 **特权网关意图 (Privileged Gateway Intents)**：

*   [x] **SERVER MEMBERS INTENT**
*   [x] **MESSAGE CONTENT INTENT**

### 2. 机器人邀请权限

生成机器人邀请链接时，请确保勾选以下 **Bot Permissions**：

*   `Manage Roles` (管理身份组) - **必需**，用于自动授予奖励。
*   `Send Messages` (发送消息)
*   `Embed Links` (嵌入链接) - **必需**，所有界面都基于此。
*   `Attach Files` (附加文件) - **必需**，用于导出数据。
*   `Read Message History` (读取消息历史)

## 🔧 如何使用

1.  **启动并邀请机器人** 到您的服务器。
2.  在一个您希望设置为挑战中心的频道，使用 `/道馆 召唤` 命令。此命令现在支持可选的 `role_to_add` 和 `role_to_remove` 参数，用于配置全局通关奖励。例如：
    *   只奖励身份组: `/道馆 召唤 role_to_add:@奖励身份组`
    *   只移除身份组: `/道馆 召唤 role_to_remove:@旧身份组`
    *   奖励并移除: `/道馆 召唤 role_to_add:@新身份组 role_to_remove:@旧身份组`
3.  使用 `/道馆 建造` 命令来创建您的第一个道馆。您可以参考项目中的 `道馆示例.json` 文件来编写您的道馆数据。
4.  创建成功后，用户就可以通过挑战面板开始挑战了！

## 📝 道馆JSON格式说明

道馆的所有内容都通过一个JSON文件进行定义。以下是一些关键的格式说明：

### 填空题多答案支持

为了提高灵活性，`fill_in_blank` 类型的题目现在支持多个正确答案。只需将 `correct_answer` 字段的值设置为一个字符串数组即可。

**示例:**
```json
{
  "id": "q3_channel_knowledge",
  "type": "fill_in_blank",
  "text": "官方的重要通知会在哪个频道发布？",
  "correct_answer": [
    "#📢｜公告发布",
    "公告发布"
  ]
}
```
在上述例子中，用户回答 `#📢｜公告发布` 或 `公告发布` 都会被判为正确。机器人会自动忽略答案的大小写和首尾空格。

### 随机题库设置

您可以选择让道馆从题库中随机抽取一部分题目进行考核。只需在JSON的顶层添加一个可选的 `questions_to_ask` 字段即可。

**示例:**
```json
{
  "id": "community_navigation",
  "name": "🧭 社区导航道馆",
  "description": "...",
  "tutorial": [...],
  "questions_to_ask": 2,
  "questions": [
    { "id": "q1", ... },
    { "id": "q2", ... },
    { "id": "q3", ... }
  ]
}
```
在这个例子中，尽管题库中有3道题，但每次用户挑战时，机器人只会随机抽取其中的2道题进行考核。如果省略 `questions_to_ask` 字段，机器人则会按顺序提问所有题目。

### 判断题支持

除了选择题和填空题，机器人现在原生支持判断题。

**示例:**
```json
{
 "id": "q4_true_false",
 "type": "true_false",
 "text": "判断题：在提问时，为了尽快得到答案，可以直接私信管理员或热心成员。",
 "correct_answer": "错误"
}
```
当 `type` 设置为 `true_false` 时，机器人会自动生成“正确”和“错误”两个按钮供用户选择。您只需在 `correct_answer` 中指定正确答案即可。

### 容错机制设置

您可以为每个道馆设置一定的容错空间，允许用户在答错指定数量的题目后依然能够通关。只需在JSON的顶层添加一个可选的 `allowed_mistakes` 字段。

**示例:**
```json
{
 "id": "advanced_knowledge",
 "name": "⚙️ 进阶知识道馆",
 "description": "...",
 "tutorial": [...],
 "questions_to_ask": 5,
 "allowed_mistakes": 1,
 "questions": [
   { "id": "q1", ... },
   { "id": "q2", ... },
   { "id": "q3", ... },
   { "id": "q4", ... },
   { "id": "q5", ... }
 ]
}
```
在这个例子中，用户需要回答5道题，但只要答错的题目数量不超过1题（即最多错1题），挑战就会被判为成功。如果省略 `allowed_mistakes` 字段，则默认值为0，用户必须全部答对才能通关。

## 📄 许可证

本项目采用 [MIT License](LICENSE) 开源许可证。

## ✍️ 作者

*   **Molilili001**